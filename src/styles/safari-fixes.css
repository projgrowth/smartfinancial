@tailwind utilities;

@layer utilities {
  /* Safari-specific root styles */
  .is-safari {
    /* Enhanced momentum scrolling for Safari */
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
  }

  /* Critical fix: Remove body height constraints on Safari mobile */
  .is-safari-mobile body {
    height: auto !important;
    min-height: 100vh;
    min-height: var(--vh, 100vh);
    overflow-x: hidden;
    overflow-y: auto;
  }

  /* Fix main container to allow natural scrolling */
  .is-safari-mobile .safari-scroll-container {
    height: auto !important;
    min-height: 100vh;
    min-height: var(--vh, 100vh);
    overflow: visible !important;
  }

  .is-ios {
    /* iOS specific viewport handling */
    height: 100vh;
    height: -webkit-fill-available;
    min-height: -webkit-fill-available;
  }

  .is-safari-mobile {
    /* Mobile Safari optimizations */
    position: relative;
    overflow-x: hidden;
    -webkit-text-size-adjust: 100%;
    -webkit-font-smoothing: antialiased;
  }

  /* Dynamic viewport height support */
  .safari-full-height {
    height: 100vh;
    height: calc(var(--vh, 1vh) * 100);
  }

  .safari-min-height {
    min-height: 100vh;
    min-height: calc(var(--vh, 1vh) * 100);
  }

  /* Address bar compensation */
  .safari-nav-offset {
    padding-top: var(--nav-h-adjusted, var(--nav-h, 80px));
  }

  /* Enhanced scroll momentum for Safari */
  .safari-smooth-scroll {
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior-y: contain;
  }

  /* Safari scroll snap optimizations */
  .safari-scroll-snap {
    scroll-snap-type: y proximity;
    -webkit-scroll-snap-type: y proximity;
  }

  .safari-scroll-snap-item {
    scroll-snap-align: start;
    -webkit-scroll-snap-align: start;
  }

  /* GPU acceleration for smooth animations on Safari */
  .safari-gpu-accelerated {
    -webkit-transform: translate3d(0, 0, 0);
    transform: translate3d(0, 0, 0);
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    -webkit-perspective: 1000px;
    perspective: 1000px;
  }

  /* Touch action optimizations for Safari */
  .safari-touch-pan-y {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    touch-action: pan-y !important;
  }

  .safari-touch-manipulation {
    touch-action: manipulation !important;
    -webkit-touch-callout: none;
  }

  /* Critical: Override conflicting touch-action declarations */
  .is-safari-mobile * {
    touch-action: auto !important;
  }

  .is-safari-mobile body,
  .is-safari-mobile .safari-scroll-container {
    touch-action: pan-y !important;
  }

  /* Prevent iOS zoom on input focus */
  @supports (-webkit-touch-callout: none) {
    input, select, textarea {
      font-size: 16px !important;
      transform: translateZ(0);
    }
  }

  /* Safari elastic bounce fix */
  .safari-no-bounce {
    overscroll-behavior: none;
    -webkit-overflow-scrolling: auto;
  }

  /* Momentum scrolling with controlled boundaries */
  .safari-momentum-contained {
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
    scroll-behavior: smooth;
  }

  /* Safari-specific modal and overlay fixes */
  .safari-modal-fix {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    height: 100vh;
    height: calc(var(--vh, 1vh) * 100);
    -webkit-overflow-scrolling: touch;
  }

  /* Performance optimizations for Safari animations */
  .safari-animation-optimized {
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
    will-change: transform, opacity;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
  }

  /* Safari-specific reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .is-safari * {
      -webkit-animation-duration: 0.01ms !important;
      animation-duration: 0.01ms !important;
      -webkit-animation-iteration-count: 1 !important;
      animation-iteration-count: 1 !important;
      -webkit-transition-duration: 0.01ms !important;
      transition-duration: 0.01ms !important;
    }
  }

  /* Safari scroll indicator styling */
  .is-safari::-webkit-scrollbar {
    width: 4px;
  }

  .is-safari::-webkit-scrollbar-track {
    background: transparent;
  }

  .is-safari::-webkit-scrollbar-thumb {
    background: hsl(var(--muted-foreground) / 0.3);
    border-radius: 2px;
  }

  .is-safari::-webkit-scrollbar-thumb:hover {
    background: hsl(var(--muted-foreground) / 0.5);
  }
}

/* CSS Custom Properties for Safari viewport handling */
:root {
  --vh: 1vh;
  --vw: 1vw;
  --address-bar-height: 0px;
  --nav-h-adjusted: var(--nav-h, 80px);
}

/* Safari-specific media queries */
@supports (-webkit-touch-callout: none) {
  /* iOS Safari styles - Fixed to not lock scroll */
  body:not(.is-safari-mobile) {
    position: relative;
    height: 100vh;
    height: -webkit-fill-available;
    overflow-x: hidden;
  }

  /* Fix for Safari's viewport height issue */
  .full-screen-container {
    height: 100vh;
    height: calc(var(--vh, 1vh) * 100);
  }
}

/* iPad Safari specific fixes */
@media screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) {
  .safari-ipad-fix {
    -webkit-text-size-adjust: none;
  }
}

/* iPhone Safari specific fixes */
@media screen and (max-device-width: 480px) and (-webkit-min-device-pixel-ratio: 2) {
  .safari-iphone-fix {
    -webkit-text-size-adjust: 100%;
    -webkit-font-smoothing: antialiased;
  }
}